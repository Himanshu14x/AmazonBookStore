pipeline {
  agent any

  environment {
    MAVEN_TOOL = 'Maven-3.8.8'   // <<--- change to the exact Maven name in Manage Jenkins -> Global Tool Configuration
    JDK_TOOL   = 'JDK11'         // <<--- change to your JDK tool name
  }

  tools {
    maven "${env.MAVEN_TOOL}"
    jdk "${env.JDK_TOOL}"
  }

  options {
    buildDiscarder(logRotator(numToKeepStr: '10'))
    timestamps()
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Prepare') {
      steps {
        echo "Using JDK: ${env.JDK_TOOL}, Maven: ${env.MAVEN_TOOL}"
        sh 'java -version'
        sh 'mvn -version'
      }
    }

    stage('Build & Test') {
      steps {
        sh 'mvn -B -V clean test'
      }
    }

    stage('Package') {
      steps {
        sh 'mvn -B -V package'
      }
    }

    stage('Archive Artifact') {
      steps {
        archiveArtifacts artifacts: 'target/*.jar, target/*.war', fingerprint: true, allowEmptyArchive: false
      }
    }
  }

  post {
    always {
      // run junit and artifact archiving inside a node so they have a Launcher/Workspace
      script {
        // allocate a node so steps that need a launcher run properly
        node {
          // publish unit test results
          junit 'target/surefire-reports/*.xml'

          // keep test reports archived as well (optional)
          archiveArtifacts artifacts: 'target/surefire-reports/**', allowEmptyArchive: true
        }
      }
    }
    success {
      echo 'Build succeeded — artifact archived.'
    }
    failure {
      echo 'Build failed — check console output and JUnit results.'
    }
  }
}
